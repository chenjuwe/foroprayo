name: æ¸¬è©¦è¦†è“‹ç‡ç›£æ§

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤© UTC 2:00 åŸ·è¡Œ (å°ç£æ™‚é–“ 10:00)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      threshold_check:
        description: 'æ˜¯å¦åŸ·è¡Œé–¾å€¼æª¢æŸ¥'
        required: false
        default: true
        type: boolean

jobs:
  test-coverage:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£ä¾è³´
      run: npm ci
      
    - name: å‰µå»ºå¿…è¦çš„ç›®éŒ„
      run: |
        mkdir -p test-results
        mkdir -p coverage
        
    - name: åŸ·è¡Œæ¸¬è©¦è¦†è“‹ç‡ç›£æ§
      run: npm run test:coverage:monitor
      env:
        CI: true
        THRESHOLD_CHECK: ${{ github.event.inputs.threshold_check || 'true' }}
        
    - name: ä¸Šå‚³è¦†è“‹ç‡å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-${{ github.run_number }}
        path: |
          coverage/
          TEST_COVERAGE_REPORT.md
          test-results/coverage-history.json
        retention-days: 30
        
    - name: ä¸Šå‚³è¦†è“‹ç‡åˆ° Codecov
      uses: codecov/codecov-action@v3
      if: always()
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        
    - name: è©•è«– PR è¦†è“‹ç‡å ±å‘Š
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = './TEST_COVERAGE_REPORT.md';
          
          if (fs.existsSync(path)) {
            const report = fs.readFileSync(path, 'utf8');
            
            // æŸ¥æ‰¾æ˜¯å¦å·²æœ‰è¦†è“‹ç‡è©•è«–
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(comment => 
              comment.body.includes('## ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š')
            );
            
            const commentBody = \`## ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š
            
          \${report}
          
          ---
          *æ­¤å ±å‘Šç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ - Run #${{ github.run_number }}*\`;
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
          }
          
    - name: æª¢æŸ¥è¦†è“‹ç‡é–¾å€¼
      if: github.event.inputs.threshold_check != 'false'
      run: |
        if [ $? -ne 0 ]; then
          echo "âŒ æ¸¬è©¦è¦†è“‹ç‡æœªé”åˆ°è¦æ±‚çš„é–¾å€¼"
          exit 1
        else
          echo "âœ… æ¸¬è©¦è¦†è“‹ç‡é”åˆ°è¦æ±‚"
        fi
        
    - name: æäº¤è¦†è“‹ç‡æ­·å²è¨˜éŒ„
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -f "test-results/coverage-history.json" ]; then
          git add test-results/coverage-history.json
          git add TEST_COVERAGE_REPORT.md
          
          if ! git diff --staged --quiet; then
            git commit -m "chore: æ›´æ–°æ¸¬è©¦è¦†è“‹ç‡æ­·å²è¨˜éŒ„ [skip ci]"
            git push
          else
            echo "æ²’æœ‰è¦†è“‹ç‡è®Šæ›´éœ€è¦æäº¤"
          fi
        fi
        
  coverage-trend-analysis:
    runs-on: ubuntu-latest
    needs: test-coverage
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ä¸‹è¼‰è¦†è“‹ç‡æ­·å²
      uses: actions/download-artifact@v4
      with:
        name: coverage-report-${{ github.run_number }}
        path: ./
        
    - name: è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£ä¾è³´
      run: npm ci
      
    - name: ç”Ÿæˆè¶¨å‹¢åˆ†æå ±å‘Š
      run: |
        node -e "
        const { analyzeCoverageTrend } = require('./scripts/test-coverage-monitor.js');
        const fs = require('fs');
        
        if (fs.existsSync('test-results/coverage-history.json')) {
          const history = JSON.parse(fs.readFileSync('test-results/coverage-history.json', 'utf8'));
          const trends = analyzeCoverageTrend(history);
          
          console.log('ğŸ“ˆ è¦†è“‹ç‡è¶¨å‹¢åˆ†æ:');
          console.log(JSON.stringify(trends, null, 2));
          
          // ç”Ÿæˆé€±å ±æˆ–æœˆå ±
          const report = {
            date: new Date().toISOString(),
            trends,
            history: history.slice(-7) // æœ€è¿‘7æ¬¡è¨˜éŒ„
          };
          
          fs.writeFileSync('coverage-trend-report.json', JSON.stringify(report, null, 2));
        }
        "
        
    - name: ä¸Šå‚³è¶¨å‹¢å ±å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: coverage-trend-report-${{ github.run_number }}
        path: coverage-trend-report.json
        retention-days: 90 