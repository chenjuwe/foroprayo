<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好友請求欄位調試工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .instruction {
            background-color: #fff;
            border-left: 4px solid #4f46e5;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 4px 4px 0;
        }
        pre {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
        }
        .btn {
            background-color: #4f46e5;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background-color: #4338ca;
        }
        #result {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 8px 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f5f5f5;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <h1>好友請求欄位調試工具</h1>
    
    <div class="instruction">
        <h2>說明：</h2>
        <p>此工具用於檢查好友請求表中的 sender_name_at_time 欄位是否存在並已正確填充。</p>
        <ol>
            <li>點擊"檢查欄位"按鈕查看 sender_name_at_time 欄位是否存在</li>
            <li>點擊"查看請求數據"按鈕查看好友請求數據，包括 sender_name_at_time 欄位</li>
            <li>如果欄位未正確填充，點擊"修復數據"按鈕嘗試填充空值</li>
        </ol>
    </div>
    
    <div>
        <button id="checkField" class="btn">檢查欄位</button>
        <button id="viewRequests" class="btn">查看請求數據</button>
        <button id="fixData" class="btn">修復數據</button>
    </div>
    
    <div id="result">
        <p>結果將顯示在這裡...</p>
    </div>
    
    <script>
        document.getElementById('checkField').addEventListener('click', async function() {
            try {
                if (!window.supabase) {
                    document.getElementById('result').innerHTML = '<p style="color:red">請先在主應用登入，然後再回到此頁面</p>';
                    return;
                }
                
                document.getElementById('result').innerHTML = '<p>正在檢查欄位...</p>';
                
                // 檢查欄位是否存在
                const { data, error } = await window.supabase.rpc('check_column_exists', {
                    p_table: 'friend_requests',
                    p_column: 'sender_name_at_time'
                });
                
                if (error) {
                    throw new Error(`檢查欄位失敗: ${error.message}`);
                }
                
                if (data) {
                    document.getElementById('result').innerHTML = '<p style="color:green">✅ sender_name_at_time 欄位存在!</p>';
                } else {
                    document.getElementById('result').innerHTML = '<p style="color:red">❌ sender_name_at_time 欄位不存在!</p>';
                }
            } catch (error) {
                console.error(error);
                document.getElementById('result').innerHTML = `<p style="color:red">錯誤: ${error.message}</p>`;
                
                // 嘗試另一種方法
                document.getElementById('result').innerHTML += '<p>嘗試使用另一種方法檢查...</p>';
                try {
                    const { data, error } = await window.supabase
                        .from('friend_requests')
                        .select('sender_name_at_time')
                        .limit(1);
                        
                    if (error && error.message.includes('column "sender_name_at_time" does not exist')) {
                        document.getElementById('result').innerHTML += '<p style="color:red">❌ 確認 sender_name_at_time 欄位不存在!</p>';
                    } else {
                        document.getElementById('result').innerHTML += '<p style="color:green">✅ 確認 sender_name_at_time 欄位存在!</p>';
                    }
                } catch (e) {
                    document.getElementById('result').innerHTML += `<p style="color:red">另一種方法也失敗: ${e.message}</p>`;
                }
            }
        });
        
        document.getElementById('viewRequests').addEventListener('click', async function() {
            try {
                if (!window.supabase) {
                    document.getElementById('result').innerHTML = '<p style="color:red">請先在主應用登入，然後再回到此頁面</p>';
                    return;
                }
                
                document.getElementById('result').innerHTML = '<p>正在獲取請求數據...</p>';
                
                // 獲取好友請求數據
                const { data: requests, error } = await window.supabase
                    .from('friend_requests')
                    .select('*')
                    .limit(10);
                    
                if (error) {
                    throw new Error(`獲取請求數據失敗: ${error.message}`);
                }
                
                if (requests && requests.length > 0) {
                    // 檢查是否有 sender_name_at_time 欄位
                    const hasSenderNameAtTime = 'sender_name_at_time' in requests[0];
                    
                    // 獲取相關用戶資料，以便顯示實際用戶名
                    const userIds = new Set();
                    requests.forEach(req => {
                        if (req.sender_id) userIds.add(req.sender_id);
                        if (req.receiver_id) userIds.add(req.receiver_id);
                    });
                    
                    const { data: profiles } = await window.supabase
                        .from('user_profiles')
                        .select('id, username')
                        .in('id', Array.from(userIds));
                        
                    // 創建用戶ID到用戶名的映射
                    const userMap = {};
                    if (profiles) {
                        profiles.forEach(profile => {
                            userMap[profile.id] = profile.username;
                        });
                    }
                    
                    // 創建表格顯示
                    let tableHTML = '<h3>好友請求數據:</h3>';
                    tableHTML += '<table>';
                    tableHTML += '<thead><tr>';
                    tableHTML += '<th>ID</th>';
                    tableHTML += '<th>發送者ID</th>';
                    tableHTML += '<th>發送者名稱</th>';
                    tableHTML += '<th>接收者ID</th>';
                    tableHTML += '<th>狀態</th>';
                    
                    if (hasSenderNameAtTime) {
                        tableHTML += '<th>發送時名稱</th>';
                    } else {
                        tableHTML += '<th><span style="color:red">發送時名稱欄位不存在</span></th>';
                    }
                    
                    tableHTML += '</tr></thead>';
                    tableHTML += '<tbody>';
                    
                    requests.forEach(req => {
                        tableHTML += '<tr>';
                        tableHTML += `<td>${req.id}</td>`;
                        tableHTML += `<td>${req.sender_id}</td>`;
                        tableHTML += `<td>${userMap[req.sender_id] || '未知'}</td>`;
                        tableHTML += `<td>${req.receiver_id}</td>`;
                        tableHTML += `<td>${req.status || 'pending'}</td>`;
                        
                        if (hasSenderNameAtTime) {
                            if (req.sender_name_at_time) {
                                tableHTML += `<td>${req.sender_name_at_time}</td>`;
                            } else {
                                tableHTML += '<td><span style="color:orange">空值</span></td>';
                            }
                        } else {
                            tableHTML += '<td><span style="color:red">欄位不存在</span></td>';
                        }
                        
                        tableHTML += '</tr>';
                    });
                    
                    tableHTML += '</tbody></table>';
                    document.getElementById('result').innerHTML = tableHTML;
                } else {
                    document.getElementById('result').innerHTML = '<p>沒有找到請求數據</p>';
                }
            } catch (error) {
                console.error(error);
                document.getElementById('result').innerHTML = `<p style="color:red">錯誤: ${error.message}</p>`;
            }
        });
        
        document.getElementById('fixData').addEventListener('click', async function() {
            try {
                if (!window.supabase) {
                    document.getElementById('result').innerHTML = '<p style="color:red">請先在主應用登入，然後再回到此頁面</p>';
                    return;
                }
                
                document.getElementById('result').innerHTML = '<p>正在修復數據...</p>';
                
                // 首先確認欄位存在
                try {
                    const { data: columns } = await window.supabase
                        .from('friend_requests')
                        .select('sender_name_at_time')
                        .limit(1);
                        
                    // 如果沒有拋出錯誤，欄位存在
                } catch (e) {
                    // 如果欄位不存在，創建欄位
                    if (e.message.includes('column "sender_name_at_time" does not exist')) {
                        document.getElementById('result').innerHTML += '<p>欄位不存在，嘗試創建欄位...</p>';
                        
                        const { error: alterError } = await window.supabase.rpc('exec_sql', {
                            sql_query: 'ALTER TABLE friend_requests ADD COLUMN IF NOT EXISTS sender_name_at_time TEXT;'
                        });
                        
                        if (alterError) {
                            throw new Error(`創建欄位失敗: ${alterError.message}`);
                        }
                        
                        document.getElementById('result').innerHTML += '<p style="color:green">已創建欄位!</p>';
                    }
                }
                
                // 更新空值
                const { error: updateError } = await window.supabase.rpc('exec_sql', {
                    sql_query: `
                        UPDATE friend_requests fr
                        SET sender_name_at_time = (
                          SELECT username
                          FROM user_profiles up
                          WHERE up.id = fr.sender_id
                          LIMIT 1
                        )
                        WHERE fr.sender_name_at_time IS NULL;
                    `
                });
                
                if (updateError) {
                    throw new Error(`更新數據失敗: ${updateError.message}`);
                }
                
                // 創建觸發器
                const { error: triggerError } = await window.supabase.rpc('exec_sql', {
                    sql_query: `
                        CREATE OR REPLACE FUNCTION set_sender_name_at_time()
                        RETURNS TRIGGER AS $$
                        BEGIN
                          NEW.sender_name_at_time := (
                            SELECT username
                            FROM user_profiles
                            WHERE id = NEW.sender_id
                            LIMIT 1
                          );
                          RETURN NEW;
                        END;
                        $$ LANGUAGE plpgsql;

                        DROP TRIGGER IF EXISTS trigger_set_sender_name_at_time ON friend_requests;
                        
                        CREATE TRIGGER trigger_set_sender_name_at_time
                        BEFORE INSERT ON friend_requests
                        FOR EACH ROW
                        EXECUTE FUNCTION set_sender_name_at_time();
                    `
                });
                
                if (triggerError) {
                    throw new Error(`創建觸發器失敗: ${triggerError.message}`);
                }
                
                document.getElementById('result').innerHTML = '<p style="color:green">✅ 數據修復完成!</p>';
                document.getElementById('result').innerHTML += '<p>請點擊"查看請求數據"按鈕檢查結果。</p>';
            } catch (error) {
                console.error(error);
                document.getElementById('result').innerHTML = `<p style="color:red">錯誤: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html> 